<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/resource/main.css">
  <link rel="stylesheet" href="/resource/parts.css">
  <script src="https://cdn.bootcss.com/vue/2.6.11/vue.min.js"></script>
  <script src="https://cdn.bootcss.com/reqwest/2.0.5/reqwest.min.js"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.1/highlight.min.js"></script>
  <link href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.1/styles/monokai-sublime.min.css" rel="stylesheet">
  <title>将七牛附件搬迁到本地（附自动修改路径插件） | bW Archived</title>
</head>
  <body>
    <script>
      var mixins = []
    </script>
    <div id="canvas">
        <header class="full-wrapper bg space-xs" :class="{'hide-header': hideHeader, 'shrink-header': shrinkHeader, 'blurred': showLoader}">
  <div class="header-wrap main-wrapper row row-loose">
    <div class="col-5 text-xl bolder site-name major"><a href="/">bW Archived</a></div>
      <div class="col-5 menu pointer to-right" @click="showMenu()"><div class="text-l bold inline-block menu-btn" :class="{'menu-open': menuOpen}"><i class="fa fa-chevron-right" aria-hidden="true"></i></div></div>
      <nav class="nav-body col-8" :class="{'nav-open': menuOpen}">
        <ul class="h-list to-right sc">
          <li class="bg-sc-hover space-vh rounded ease" :class="{'nav-active': activeNav=='index' || activeNav=='category' || activeNav=='article'}"><a href="/">Home</a></li>
          <li class="bg-sc-hover space-vh rounded ease" :class="{'nav-active': activeNav=='tag'}"><a href="/tags/">Tags</a></li>
          <li class="bg-sc-hover space-vh rounded ease" :class="{'nav-active': activeNav=='archive'}"><a href="/archives/">Archive</a></li>
          
          
          <li class="bg-sc-hover space-vh rounded ease"><a href="https://bw.bo-blog.com" target="_blank">bW首页</a></li>
          
          
        </ul>
      </nav>
    </div>
</header>

        <main class="main-wrapper row row-loose row-top row-wrap space-xs" :class="{blurred: showLoader}">
          <div class="main-zone-wrapper full-wrapper">
          
<section class="zone-main" id="zone-main">
    <article class="space-s bg-panel rounded article-animate" style="animation-duration: 0.8s">
      <div class="title-area">
        <div class="text-xs minor">Nov. 6, 2018</div>  
        <div class="text-l bold theme-color">将七牛附件搬迁到本地（附自动修改路径插件）</div>
      </div>
      <div class="article-wrapper row row-loose row-top">
        <div>
            <div class="body-text between space-vh">
                <p><strong> ⚠️ 这篇日志的内容是关于已不再维护的Bo-Blog Wind。仅供存档，不建议您继续使用。如需了解新版程序，请访问首页。 </strong></p>
<p>由于近期七牛云存储开始回收测试域名（ <a href="https://segmentfault.com/q/1010000015811678">https://segmentfault.com/q/1010000015811678</a> ），在测试域名被回收后，原先用这个域名上传并发布的日志中的图片将无法显示。暂且不评论七牛此举是否得当，但这么多的附件要重新上传，再一篇篇更新日志，显然给我们造成了巨大的困扰。</p>
<p>为此，本文提供了迁移附件的指南，供有同样问题的用户参考。</p>
<p>迁移需要用到的工具，请先下载：<br>qshell 命令行工具： <a href="https://developer.qiniu.com/kodo/tools/1302/qshell">https://developer.qiniu.com/kodo/tools/1302/qshell</a><br>bW Qiniu Fixer新旧附件路径替换插件：<a href="https://www.bo-blog.com/bw/storage/fcaa0297.zip">https://www.bo-blog.com/bw/storage/fcaa0297.zip</a></p>
<h1 id="toc-%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4%EF%BC%9A">操作步骤：</h1><p>（以下假设被回收了域名的七牛空间名为 client，在同一区域下新建的空间名为 test4，请自行替换）<a name="more" id="more"></a></p>
<p>0) 解压qshell，请阅读qshell下载页的说明，选择适合您的系统的可执行文件。</p>
<p>1) 在旧空间（本例中名为client）的同一区，新建一个新的bucket（本例为test4）。注意，七牛会为这个新空间分配一个新的测试域名，本例假设测试域名为 php12345.bkt.clouddn.com。</p>
<p>2) 在终端中执行：</p>

<pre><code>qshell account AK SK
</code></pre>
<p>其中，AK和SK分别是您的七牛秘钥的Access Key和Secret Key。</p>
<p>3) 继续执行</p>

<pre><code>qshell listbucket client allfiles.txt
</code></pre>
<p>在qshell同一文件夹下将产生一个allfiles.txt，内含所有该空间下的文件名和文件详情。</p>
<p>4) 继续执行</p>

<pre><code>cat allfiles.txt | awk &#39;{print $1}&#39; &gt;allfiles2.txt
</code></pre>
<p>用awk获取列表结果的第一列，存于allfiles2.txt文件中。</p>
<p>5) 继续执行</p>

<pre><code>qshell batchcopy -force client test4 allfiles2.txt
</code></pre>
<p>该命令会批量把旧空间client的文件复制到新空间test4里。</p>
<p>6) 现在，我们需要将所有文件从新的空间下载到PC本机。<br>在qshell同一文件夹下，新建一纯文本文件名为 config.conf。<br>该文件中，输入下列内容：</p>

<pre><code>{
    &quot;dest_dir&quot;   :   &quot;/Users/mymac/Documents/backup&quot;,
    &quot;bucket&quot;     :   &quot;test4&quot;,
    &quot;prefix&quot;     :   &quot;&quot;,
    &quot;suffixes&quot;   :   &quot;&quot;,
    &quot;cdn_domain&quot; :   &quot;php12345.bkt.clouddn.com&quot;,
    &quot;referer&quot;    :   &quot;http://php12345.bkt.clouddn.com&quot;,
    &quot;log_file&quot;   :   &quot;/Users/mymac/Downloads/download.log&quot;,
    &quot;log_level&quot;  :   &quot;info&quot;,
    &quot;log_rotate&quot; :   1,
    &quot;log_stdout&quot; :   false
}
</code></pre>
<p>请注意，dest_dir替换为想要备份到本机的路径。bucket输入新空间名。cdn_domain和referer请填写新分配的测试域名。log_info里填一个Log文件的存放路径。</p>
<p>保存该文件后，请在终端继续执行：</p>

<pre><code>qshell qdownload config.conf
</code></pre>
<p>等待所有文件下载到本机backup文件夹下。</p>
<p>7) 现在可以关闭终端。<br>我们将下载下来的 backup/storage 目录下的全部文件，用FTP等手段上传到bW博客的storage/ 目录下。<br>至此，文件迁移完成。</p>
<p>8) 现在，还需要最后一步，也就是一次性替换旧的文件路径为 bW的本地路径，不然图片依然是无法显示的。</p>
<p>请解压先前下载的插件，打开 qiniufixer/domain.php 文件。</p>

<pre><code>&lt;?php
define (&#39;OLD_QINIU_DOMAIN&#39;, &#39;client.qiniudn.com&#39;);
define (&#39;NEW_QINIU_DOMAIN&#39;, &#39;www.myblog.com&#39;);
</code></pre>
<p>第2行引号中是旧的bucket访问域名和路径。第三行是bW的真实域名和路径。在这个例子里，迁移后的附件访问地址为 www.myblog.com/storage/xxxx.jpg。</p>
<p>如果你的bW有启用https，那么可以这样写：</p>

<pre><code>&lt;?php
define (&#39;OLD_QINIU_DOMAIN&#39;, &#39;http://client.qiniudn.com/storage&#39;);
define (&#39;NEW_QINIU_DOMAIN&#39;, &#39;https://www.myblog.com/storage&#39;);
</code></pre>
<p>9) 将整个 qiniufixer 文件夹上传到 bW的安装目录的 extension 目录下。注意只能有一层qiniufixer文件夹。某些解压软件会将文件解压成 xxxxx/qiniufixer/，请仅上传第二层。</p>
<p>然后，在浏览器内登录bW后台，到“插件扩展”里，点击“手动载入”按钮，填写目录名 qiniufixer，点击“安装”。然后启用该扩展。</p>
<p>恭喜，您已完成了紧急抢救旧空间文件、备份到本机、迁移到本地，并顺便更新了已发布的日志。</p>
<p><strong>参考链接</strong><br><a href="https://segmentfault.com/q/1010000016887800?utm_source=tag-newest">https://segmentfault.com/q/1010000016887800?utm_source=tag-newest</a></p>
<p><strong>后话</strong><br>七牛此举也许是受到了监管未备案域名的压力。但测试域名被回收后，原先上传的文件不仅不能公开显示，而且无法导出（无论是qshell，还是在那个难用至极的portal后台里都不能直接下载），这样对待用户实在太难看。我们这些轻应用自己迁移一下，写个hotfix也许不是大事，但那些存放了海量文件、系统不易修改的用户呢？不管怎么说，我们要记住一点：勤备份，把数据掌握在自己手中。</p>

            </div>
            <div class="article-info between text-xs sc">
                <div class="space-vh"><i class="fa fa-folder-o" aria-hidden="true"></i> <a href="/category/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/">快速上手</a></div>
                
                <div class="space-vh"><i class="fa fa-tag" aria-hidden="true"></i>
                    <div class="h-list inline-block">
                        <ul>
                            
                            <li><a href="/tags/#%E4%B8%83%E7%89%9B">七牛</a></li>
                            
                            <li><a href="/tags/#%E6%95%99%E7%A8%8B">教程</a></li>
                            
                        </ul>
                    </div>
                </div>
                
            </div>
        </div>
        
        <div class="article-toc space-vh text-s col-3">
            <div class="bold"><i class="fa fa-bookmark" aria-hidden="true"></i> Table of Contents</div>
            <div class="v-list" id="article-toc"><ul data-base-level="1"><li data-relative-level="1"><a href="#toc-%E6%93%8D%E4%BD%9C%E6%AD%A5%E9%AA%A4%EF%BC%9A">操作步骤：</a></li></ul></div>
        </div>
        
      </div>
    </article>

    <div class="space-xs between bg">
    <div class="row row-loose">
        <div class="to-left col-5"><span class="theme-color bold"><i class="fa fa-comment-o" aria-hidden="true"></i> Comments</span></div>
        <div class="to-right col-5">
            <div class="button space-vh rounded text-s ease" v-if="!openForm"><span class="pointer" @click="openCommentForm"><i class="fa fa-plus" aria-hidden="true"></i> Write</span></div>
        </div>
    </div>

    <div v-if="miniLoader" class="com-wrapper row row-left row-top space-s rounded">
        <div class="com-avatar">
            <div class="com-initial" style="background: var(--minor-color); opacity: 0.5;">&nbsp;</div>
        </div>
        <div class="com-body text-xs col-9">
            <div class="com-title">
                <place-holder width="20"></place-holder>
                <place-holder width="90"></place-holder>
            </div>
        </div>
    </div>

    <div class="com-form ease" :class="{'com-form-open': openForm}">
        <input type="text" placeholder="Name" @focus="requestSiteKey" v-model="user" :class="{'com-error': errorUser}"> *<br>
        <span class="com-error-msg-off ease text-xs" :class="{'com-error-msg-on': errorUser}">Name must be at least 2 characters long.</span>
        <input type="email" placeholder="Email" @focus="requestSiteKey" v-model="email" :class="{'com-error': errorEmail}"> *<br>
        <span class="com-error-msg-off ease text-xs" :class="{'com-error-msg-on': errorEmail}">Email must be a commonly valid one.</span>
        <input type="url" placeholder="Website" @focus="requestSiteKey" v-model="url"><br>
        <textarea @focus="requestSiteKey" v-model="content" :class="{'com-error': errorContent}"></textarea> <span style="vertical-align: top;">*</span>
        <span class="com-error-msg-off ease text-xs" :class="{'com-error-msg-on': errorContent}">Content must be at least 8 characters long.</span>
        <span class="com-error-msg-off ease text-xs" :class="{'com-error-msg-on': errorReturn}" v-html="errorMessage"></span>
    </div>
    <div id="submit" class="button space-vh rounded text-s ease" v-if="openForm && !lockSubmit"><span class="pointer" @click="createComment"><i class="fa fa-plus" aria-hidden="true"></i> Submit</span></div>
    <div id="submit" class="button space-vh rounded text-s ease" v-if="lockSubmit"><span class="forbidden"><i class="fa fa-spin fa-circle-o-notch" aria-hidden="true"></i> Processing</span></div>    

    <div v-if="noComments" class="space-xl to-center com-wrapper">
        No comment received. Be the first one to comment.
    </div>
    
    
    <div v-for="comment in comments" :key="comment.ref" class="com-wrapper row row-left row-top space-s rounded">
        <div class="com-avatar">
            <div class="com-initial" v-if="!comment.isAdmin">{{ comment.user.substring(0,1).toUpperCase() }}</div>
            <img :src="adminAvatar" v-if="comment.isAdmin">
        </div>
        
        <div class="com-body text-xs">
            <div class="com-title">
                <span class="com-name bold text-s" :class="{'theme-color': comment.isAdmin}">{{ comment.user }}</span>
                <span class="com-date text-xxs sc">{{ dateFormat(comment.time) }}</span>
                <span class="text-xs minor" v-if="comment.isAdmin" title="Administrator"><i class="fa fa-user-circle-o" aria-hidden="true"></i></span>
                <span class="text-xs minor pointer" title="Email" v-if="comment.email"><a :href="'mailto:'+comment.email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a></span>
                <span class="text-xs minor pointer" title="Website" v-if="comment.url"><a :href="comment.url" target="_blank" rel="nofollow"><i class="fa fa-external-link" aria-hidden="true"></i></a></span>
            </div>
            <div class="com-content" v-html="comment.content">
            </div>
        </div>
    </div>
    
</div>

<script src="https://cdn.bootcdn.net/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
<script>        
    mixins.push({
        data: {
            comments: [],
            miniLoader: false,
            adminAvatar: "",
            noComments: false,
            openForm: false,
            hashKey: null,
            ts: null,
            user: "",
            url: "",
            email: "",
            content: "",
            admin: "",
            errorMessage: "Test",
            errorUser: false,
            errorEmail: false,
            errorContent: false,
            errorReturn: false,
            lockSubmit: false,
            now: moment(),
            lastSubmitted: ""
        },
        methods: {
            openCommentForm() {
                this.openForm = true
            },
            dateFormat(ts) {
                let rs = ""
                let thatTime = moment(ts*1000)
                let tsDiff = this.now.diff(thatTime, 'seconds')
                if (tsDiff < 10) {
                    rs = "Just now"
                }
                else if (tsDiff < 60) {
                    rs = tsDiff+" seconds ago"
                }
                else if (tsDiff < 3600) {
                    rs = Math.floor(tsDiff / 60)+" minutes ago"
                }
                else if (tsDiff < 86400) {
                    rs = Math.floor(tsDiff / 3600)+" hours "
                    if (Math.floor(tsDiff % 3600) != 0) {
                        rs += Math.floor(tsDiff % 3600 / 60)+" minutes "
                    }
                    rs += "ago"
                }
                else if (tsDiff < 691200) {
                    rs = Math.floor(tsDiff / 86400)+" days ago "
                }
                else {
                    rs = thatTime.format("MMM D, YYYY")
                }
                return rs
            },
            requestSiteKey() {
                this.errorUser = false
                this.errorEmail = false
                this.errorContent = false
                this.errorReturn = false
                var self = this
                if(!this.hashKey) {
                    reqwest({
                        url: 'https://elated-poincare-100f1b.netlify.app/.netlify/functions/initialize-post/47b30055dec729068c1f26ee62bb3d38',
                        type: 'json',
                        success: function (resp) {
                            if(resp.key && resp.ts) {
                                self.hashKey = resp.key
                                self.ts = resp.ts
                            }
                        }
                    })
                }
            },
            createComment() {
                exitSubmit = false
                if (this.user.length < 2) {
                    this.errorUser = true
                    exitSubmit = true
                }
                if (/^([A-Za-z0-9_\-\.\u4e00-\u9fa5])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,8})$/.test(this.email) === false) {
                    this.errorEmail = true
                    exitSubmit = true
                }
                if (this.content.length < 8) {
                    this.errorContent = true
                    exitSubmit = true
                }
                else if (this.content == this.lastSubmitted) {
                    this.errorReturn = true
                    this.errorMessage = "Do not submit the same content twice. If a comment is pending approval, please wait for the admin to act."
                    exitSubmit = true
                }
                if (exitSubmit) {
                    this.lockSubmit = false
                    return false
                }
                else {
                    this.lockSubmit = true
                    let data = {
                        hashKey: this.hashKey,
                        postID: "47b30055dec729068c1f26ee62bb3d38",
                        ts: this.ts,
                        postTitle: "将七牛附件搬迁到本地（附自动修改路径插件）",
                        postURL: "/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/relocate-qiniu-files/",
                        user: this.user,
                        email: this.email,
                        content: this.content,
                        url: this.url,
                        admin: this.admin
                    }

                    var self = this
                    reqwest({                
                        url: 'https://elated-poincare-100f1b.netlify.app/.netlify/functions/create-comment/47b30055dec729068c1f26ee62bb3d38?data='+JSON.stringify(data),
                        method: "get",                     
                        success: function(resp) {
                            //console.log (resp)
                            if (resp.ref) {
                                self.lastSubmitted = data.content
                                self.comments.unshift(data)
                                self.noComments = false
                                self.content = ""
                                self.ts = null
                                self.hashKey = null
                                self.openForm = false
                            }
                            else if (resp.error) {
                                self.errorReturn = true
                                self.errorMessage = resp.message
                            }
                        },
                        error: function(err) {
                            self.errorReturn = true
                            if (err.message) {
                                self.errorMessage = err.message
                            }
                            else {
                                self.errorMessage = "Unable to submit. Error: "+JSON.stringify(err)
                            }
                        },
                        complete: function(resp) {
                            self.lockSubmit = false
                        }
                    })
                }
            }
        },
        mounted() {
            this.miniLoader = true
            var self = this
            setTimeout(function(){
                reqwest({
                    url: 'https://elated-poincare-100f1b.netlify.app/.netlify/functions/get-comment/47b30055dec729068c1f26ee62bb3d38',
                    type: 'json',
                    success: function (resp) {
                        if (resp.data) {
                            if (resp.data.length > 0) {
                                setTimeout(function() {
                                    self.comments = resp.data
                                    self.miniLoader = false
                                }, 300)
                                return
                            }
                        }
                        self.noComments = true
                        self.miniLoader = false
                        //console.log(resp)
                        
                    },
                    error: function () {
                        self.miniLoader = false
                    }
                })
            }, 1000)
        }
    })
</script>
   
    <div class="article-adjacent full-wrapper row row-top row-loose row-wrap text-xs sc">
        <div class="space-vh"><i class="fa fa-arrow-left" aria-hidden="true"></i> Previous: <a href="/%E9%9A%8F%E7%AC%94/happy-new-year/">Happy New Year</a></div>
        <div class="space-vh">Next: <a href="/%E9%9A%8F%E7%AC%94/now-https/">我们切换到了https</a> <i class="fa fa-arrow-right" aria-hidden="true"></i></div>
    </div>
</section>
<script>
    mixins.push({
        data: {
            anchorPos: [],
            activeAnchor: -1
        },
        methods: {
            bindToc() {                
                let allAnchors = document.querySelectorAll("#article-toc ul li a")
                if (allAnchors.length>0) {
                    for (anchor of allAnchors) {
                        let targetID = anchor.hash
                        this.anchorPos.push(document.getElementById(targetID.substring(1)).offsetTop)
                    }
                    console.log(this.anchorPos)
                    window.addEventListener('scroll', this.updateToc) 
                }
            },
            updateToc() {
                if (this.anchorPos.length>0) {
                    for (an in this.anchorPos) {
                        if (this.anchorPos[an] <= this.windowScrolled) {
                            this.activeAnchor = an
                        }
                        else {
                            break;
                        }
                    }
                    
                    let allAnchors = document.querySelectorAll("#article-toc ul li")
                    for (let i=0; i<allAnchors.length; i++) {
                        if (i==this.activeAnchor) {
                            allAnchors[i].classList.add("toc-highlight")
                        }
                        else {
                            allAnchors[i].classList.remove("toc-highlight")
                        }
                    }
                }
            }
        },
        mounted() {
            window.setTimeout(this.bindToc, 500)  
        }
    })

</script>

          </div>
          
        </main>

        <footer class="main-wrapper" :class="{blurred: showLoader}">
  <div class="space-s between to-center">
    <div class="space-xxs to-center">
      <div class="h-list sc text-l">
        <ul>
          
          <li class="contact-item"><a href="http://weibo.com/" target="_blank" title="Weibo"><i class="fa fa-weibo" aria-hidden="true"></i></a></li>
          
          <li class="contact-item"><a href="https://twitter.com/" target="_blank" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
          
          <li class="contact-item"><a href="http://instagram.com/" target="_blank" title="Instagram"><i class="fa fa-instagram" aria-hidden="true"></i></a></li>
          
        </ul>
      </div>
    </div>
    <div class="text-xs sc">&copy; Bo-blog 2020.<br>Powered by <a href="/" target="_blank">Project Haru</a></div>
  </div>
</footer>

<div class="loader ease" :class="{'loader-on': showLoader}">
  <div class="lightbox"></div>
  <div class="loading">
    <i class="left"></i>
    <i class="middle"></i>
    <i class="right"></i>
  </div>
</div>
    </div> 
    
  <script>
  Vue.component ('place-holder', {
      template: "<div class=\"place-holder\" :style=\"{width: phWidth}\">.</div>",
      props: ['width'],
      computed: {
          phWidth() {
              return this.width + "%"
          }
      }
  })
  var app = new Vue({
      el: "#canvas",
      mixins: mixins,
      data: {
         menuOpen: false,
         windowScrolled: false,
         windowScrollUp: false,
         showLoader: false,
         activeNav: 'index',
      },
      methods: {
          showMenu () {
              this.menuOpen = !this.menuOpen;
          },
          windowScroller () {
              var scrolled = document.documentElement.scrollTop || document.body.scrollTop
              this.windowScrollUp = scrolled < this.windowScrolled
              this.windowScrolled = scrolled
          },
          scrollToTop () {
              window.scrollTo({ 
                  top: 0, 
                  behavior: "smooth" 
              })
          },
          lightsOn () {
              var self = this
              setTimeout(function() {
                  self.scrollToTop ()
                  self.showLoader = false
              }, 600)
          }
      },
      mounted () { 
          window.addEventListener('scroll', this.windowScroller) 
          if (location.hash && location.hash!=="#") {
            window.setTimeout(function(){
                let dest = location.hash.substring(1)
                document.getElementById(dest).scrollIntoView()                
            }, 500)  
        }
      },
      computed: {
          hideHeader() {
              return this.windowScrolled > 30
          },
          shrinkHeader() {
              return this.windowScrolled > 30 && this.windowScrollUp
          },                
      }
  })
</script>  
  <script>
    document.addEventListener('DOMContentLoaded', (event) => {
      document.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightBlock(block);
      });
    });
  </script>
  </body>
</html>